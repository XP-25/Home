<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Classroom Monitors - Multiplayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet" />
    <style>
        :root {
            --wood-dark: #6b5b4b;
            --wood-light: #8c6f5a;
            --wall-color: #a29587;
            --floor-tile1: #7d7062;
            --floor-tile2: #8a7f75;
            --corridor-tile1: #666;
            --corridor-tile2: #777;
            --ui-bg: #4a3f35;
            --ui-panel: #5a4f45;
            --text-light: #f0e0d0;
            --border-light: #f0e0d0;
            --shadow-dark: #3a2f25;
            --shadow-light: #ffffff;
        }
        body,
        html {
            height: 100vh;
            overflow: hidden;
            font-family: "VT323", monospace;
            background-color: var(--ui-bg);
            color: var(--text-light);
        }

        .pixel-border {
            border: 4px solid var(--border-light);
            box-shadow: inset -4px -4px 0px 0px var(--shadow-dark),
                inset 4px 4px 0px 0px var(--shadow-light);
        }

        .pixel-border-inner {
            border: 4px solid var(--border-light);
            box-shadow: inset 4px 4px 0px 0px var(--shadow-dark),
                inset -4px -4px 0px 0px var(--shadow-light);
        }

        .student-face,
        .teacher-face {
            width: 45px;
            height: 45px;
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            z-index: 10;
            background-repeat: no-repeat;
        }

        .student-bench {
            width: 140px;
            height: 60px;
        }

        .student.standing .student-face {
            transform: translateY(-10px);
            border: 3px solid #ff4136;
            border-radius: 4px;
        }

        .speech-bubble {
            display: none;
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            background-color: white;
            color: black;
            padding: 2px 6px;
            border-radius: 6px;
            border: 2px solid black;
            white-space: nowrap;
            animation: pop-up 0.5s forwards;
            z-index: 20;
        }

        .student.talking .speech-bubble {
            display: block;
        }

        @keyframes pop-up {
            0% {
                transform: translateX(-50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translateX(-50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) scale(1);
                opacity: 0;
            }
        }

        .teacher-nod {
            animation: nod 1.5s infinite ease-in-out;
        }

        @keyframes nod {
            0%,
            100% {
                transform: rotate(0deg);
            }
            50% {
                transform: rotate(5deg);
            }
        }

        #game-container {
            width: 100%;
            max-width: 1200px;
            margin: auto;
            height: 100%;
        }

        #classroom-container {
            background-color: var(--shadow-dark);
        }

        .classroom-floor {
            background-color: var(--floor-tile1);
            background-image: linear-gradient(var(--floor-tile2) 50%, transparent 50%),
                linear-gradient(90deg, var(--floor-tile2) 50%, transparent 50%);
            background-size: 40px 40px;
        }
        .corridor-floor {
            background-color: var(--corridor-tile1);
            background-image: linear-gradient(var(--corridor-tile2) 50%, transparent 50%),
                linear-gradient(90deg, var(--corridor-tile2) 50%, transparent 50%);
            background-size: 30px 30px;
        }

        .wall {
            background-color: var(--wall-color);
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            height: 25%;
            border-bottom: 8px solid var(--shadow-dark);
        }

        .window {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 120px;
            height: 60px;
            background-color: #87ceeb;
            border: 6px solid var(--wood-dark);
            box-shadow: inset 0 0 0 4px var(--wood-light);
        }

        .window-pane::before,
        .window-pane::after {
            content: "";
            position: absolute;
            background-color: var(--wood-dark);
        }

        .window-pane::before {
            left: 50%;
            top: -6px;
            bottom: -6px;
            width: 6px;
            transform: translateX(-50%);
        }

        .window-pane::after {
            top: 50%;
            left: -6px;
            right: -6px;
            height: 6px;
            transform: translateY(-50%);
        }

        .locker {
            width: 80%;
            height: 45px;
            background-color: #95a5a6;
            border: 4px solid #7f8c8d;
            position: relative;
        }

        .locker::after {
            content: "";
            position: absolute;
            top: 50%;
            right: 5px;
            width: 4px;
            height: 12px;
            background: #34495e;
            transform: translateY(-50%);
        }
        #chat-messages {
            overflow-y: auto;
            max-height: 150px;
            min-height: 150px;
        }

        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        #chat-messages::-webkit-scrollbar-track {
            background: var(--ui-panel);
            border-radius: 4px;
        }

        #chat-messages::-webkit-scrollbar-thumb {
            background: var(--wood-dark);
            border-radius: 4px;
        }

        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--wood-light);
        }
        /* Mobile Styles */
        @media (max-width: 1024px) {
            .student-bench {
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
                width: auto !important;
                height: auto;
                background-color: var(--wood-light);
                border-radius: 12px;
                padding: 4px;
                margin-bottom: 8px;
            }

            #benches {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 4px;
                padding: 2px;
            }

            .student-face {
                width: 40px;
                height: 40px;
            }

            #chat-messages {
                max-height: 100px;
                min-height: 100px;
            }
        }

        .expelled-verse {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            max-width: 80%;
            z-index: 100;
            animation: fadeInOut 5s forwards;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        .room-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 100;
        }
    </style>
</head>
<body class="p-4">
    <!-- Game Container -->
    <div
        id="game-container"
        class="w-full h-full max-w-7xl mx-auto flex flex-col lg:flex-row gap-4"
    >
        <!-- Info Panel -->
        <div
            class="order-2 lg:order-1 w-full lg:w-1/3 h-1/4 lg:h-full pixel-border-inner bg-[var(--ui-panel)] p-4 flex flex-row lg:flex-col gap-4"
        >
            <div class="w-1/3 lg:w-full flex flex-col justify-between">
                <div>
                    <h1 class="text-3xl text-center">Classroom Monitors</h1>
                    <p class="text-center text-yellow-300" id="player-count">
                        Players: 0/16
                    </p>
                    <p class="text-center text-blue-300 text-sm" id="room-info">
                        Room: Loading...
                    </p>
                </div>
                <div id="player-info" class="text-lg text-center">
                    <p>Your Name:
                        <span id="player-name" class="font-bold text-yellow-300"
                            >Waiting...</span
                        ></p>
                    <p>
                        Behaviour Credits:
                        <span id="player-credits" class="font-bold text-green-400"
                            >15</span
                        >
                    </p>
                </div>
                <div
                    id="game-status"
                    class="text-center text-xl text-yellow-300 h-12"
                >
                    Waiting for players...
                </div>
            </div>
            <div
                class="w-2/3 lg:w-full flex-grow flex flex-col bg-[var(--shadow-dark)] pixel-border p-2"
            >
                <div
                    id="chat-messages"
                    class="flex-grow overflow-y-auto p-2 space-y-2"
                >
                    <div class="text-center text-gray-400">
                        Class chat will appear here
                    </div>
                </div>
                <div class="flex mt-2">
                    <input
                        type="text"
                        id="chat-input"
                        class="w-full bg-[var(--text-light)] text-black p-2 pixel-border-inner focus:outline-none"
                        placeholder="Talk to your benchmate..."
                        disabled
                    />
                    <button
                        id="send-btn"
                        class="ml-2 bg-green-500 hover:bg-green-600 px-4 pixel-border"
                        disabled
                    >
                        Send
                    </button>
                </div>
            </div>
        </div>

        <!-- Classroom Panel -->
        <div
            id="classroom-container"
            class="order-1 lg:order-2 w-full lg:w-2/3 h-3/4 lg:h-full pixel-border p-2 relative"
        >
            <!-- Corridor -->
            <div
                id="corridor"
                class="absolute top-0 left-0 h-full w-16 flex flex-col items-center py-4 space-y-4 z-0"
            >
                <div class="corridor-floor absolute inset-0"></div>
                <div
                    class="relative w-full h-full flex flex-col items-center justify-center space-y-2"
                >
                    <div class="locker"></div>
                    <div class="locker"></div>
                    <div class="locker"></div>
                    <div class="locker"></div>
                </div>
                <div
                    class="text-center transform -rotate-90 origin-center whitespace-nowrap absolute top-1/2 left-0 -translate-y-1/2 text-2xl"
                    style="left: -5px"
                >
                    Corridor
                </div>
            </div>
            <!-- Classroom -->
            <div id="classroom" class="ml-16 h-full relative overflow-hidden">
                <!-- Background Assets -->
                <div class="classroom-floor absolute inset-0"></div>
                <div class="wall"></div>
                <div class="window">
                    <div class="window-pane"></div>
                </div>

                <!-- Foreground Assets -->
                <div
                    class="absolute top-4 left-1/2 transform -translate-x-1/2 w-2/3 h-10 bg-green-800 pixel-border-inner flex items-center justify-center z-10"
                >
                    <span class="text-white">Blackboard</span>
                </div>
                <div
                    id="exit-sign"
                    class="hidden lg:flex absolute bottom-0 right-0 w-8 h-24 bg-red-700 pixel-border-inner items-center justify-center z-10"
                >
                    <span class="transform rotate-90 whitespace-nowrap">EXIT</span>
                </div>
                <!-- Teacher Area -->
                <div
                    class="absolute top-20 left-1/2 transform -translate-x-1/2 flex flex-col items-center z-10"
                >
                    <div
                        id="teacher-container"
                        class="bg-[var(--floor-tile2)] p-2 rounded-md pixel-border-inner"
                    >
                    </div>
                </div>
                <!-- Benches -->
                <div
                    id="benches"
                    class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-[45%] w-full h-2/3 grid grid-cols-2 gap-x-4 gap-y-2 px-4 z-10"
                >
                    <!-- Benches and students will be generated here -->
                </div>
            </div>
        </div>
    </div>
    <!-- Start Modal -->
    <div
        id="start-modal"
        class="absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"
    >
        <div class="bg-[var(--ui-bg)] pixel-border p-8 text-center max-w-lg">
            <h2 class="text-4xl mb-4">Welcome to Classroom Monitors!</h2>
            <p class="mb-2">You are about to join a classroom with up to 15 other students.</p>
            <p class="mb-2">
                When the teacher catches someone talking, they become the monitor.
            </p>
            <p class="mb-4">
                As monitor, you must catch other students talking. If your credits
                reach zero, you'll be expelled!
            </p>
            <div class="mb-4">
                <label for="player-name-input" class="block text-left mb-2"
                    >Your Name:</label
                >
                <input
                    type="text"
                    id="player-name-input"
                    class="w-full p-2 bg-[var(--text-light)] text-black pixel-border-inner"
                    placeholder="Enter your name"
                    maxlength="15"
                />
            </div>
            <button
                id="join-game-btn"
                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 pixel-border"
            >
                Join Game
            </button>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // --- DOM ELEMENTS ---
            const gameStatus = document.getElementById("game-status");
            const benchesContainer = document.getElementById("benches");
            const teacherContainer = document.getElementById("teacher-container");
            const startModal = document.getElementById("start-modal");
            const joinGameBtn = document.getElementById("join-game-btn");
            const playerNameInput = document.getElementById("player-name-input");
            const chatInput = document.getElementById("chat-input");
            const sendBtn = document.getElementById("send-btn");
            const chatMessages = document.getElementById("chat-messages");
            const playerNameEl = document.getElementById("player-name");
            const playerCreditsEl = document.getElementById("player-credits");
            const corridor = document.getElementById("corridor");
            const playerCountEl = document.getElementById("player-count");
            const roomInfoEl = document.getElementById("room-info");
            
            // --- GAME STATE ---
            let students = [];
            let teacher = {};
            let gameStarted = false;
            let teacherIsMonitoring = true;
            let monitorId = null;
            let playerId = null;
            let playerName = "";
            let socket = null;
            let currentRoom = null;

            // --- ARTIST DATA WITH IMAGES ---
            const ARTISTS = [
                {
                    name: "Kendrick Lamar",
                    verse: "I'm a sinner who's probably gonna sin again, Lord forgive me!",
                    color: "#643200",
                    image: "ChaarDiwari.png"
                },
                {
                    name: "Drake",
                    verse: "Started from the bottom now we're here!",
                    color: "#c49159",
                    image: "ChaarDiwari.png"
                },
                {
                    name: "Travis Scott",
                    verse: "It's lit! Straight up!",
                    color: "#8c5829",
                    image: "ChaarDiwari.png"
                },
                {
                    name: "Pusha T",
                    verse: "If you know you know, it's not a game!",
                    color: "#5a3a1a",
                    image: "ChaarDiwari.png"
                },
                {
                    name: "21 Savage",
                    verse: "I was born with a knife in my hand!",
                    color: "#a46422",
                    image: "ChaarDiwari.png"
                },
                {
                    name: "Ritviz",
                    verse: "Udd gaye, hum udd gaye, aasman ke parde!",
                    color: "#f4b41c",
                    image: "ChaarDiwari.png"
                },
                {
                    name: "Chaar Diwari",
                    verse: "Kya behenchod game hai yeh?",
                    color: "#c2a284",
                    image: "ChaarDiwari.png"
                },
                {
                    name: "Playboi Carti",
                    verse: "What? What? What? Slatt!",
                    color: "#d2b48c",
                    image: "ChaarDiwari.png"
                },
                {
                    name: "Future",
                    verse: "Mask off, Molly, Percocet!",
                    color: "#6d4c3d",
                    image: "ChaarDiwari.png"
                },
                {
                    name: "M.I.A.",
                    verse: "Live fast, die young, bad girls do it well!",
                    color: "#a46422",
                    image: "ChaarDiwari.png"
                },
                {
                    name: "HanumanKind",
                    verse: "Bajrang Bali ki jai!",
                    color: "#e0ac69",
                    image: "ChaarDiwari.png"
                },
                {
                    name: "Kanye West",
                    verse: "I am a god, even though I'm a man of God!",
                    color: "#4a2a0a",
                    image: "ChaarDiwari.png"
                },
                {
                    name: "Dr. Dre",
                    verse: "Been there, done that, but I'm back for more!",
                    color: "#8c6f5a",
                    image: "ChaarDiwari.png"
                },
                {
                    name: "Metro Boomin",
                    verse: "If young Metro don't trust you, I'm gon' shoot you!",
                    color: "#46250e",
                    image: "ChaarDiwari.png"
                },
                {
                    name: "SZA",
                    verse: "I'm sorry I'm not more attractive, I'm sorry I'm not more ladylike!",
                    color: "#a46422",
                    image: "ChaarDiwari.png"
                },
                {
                    name: "Lana Del Rey",
                    verse: "My old man is a bad man, but I love him so!",
                    color: "#f8d8be",
                    image: "ChaarDiwari.png"
                },
            ];

            // --- WEBSOCKET CONNECTION ---
            function connectWebSocket() {
                console.log("Connecting to game server...");
                
                // In production, replace with your server URL
                const wsUrl = "ws://localhost:8080";
                socket = new WebSocket(wsUrl);

                socket.onopen = function() {
                    console.log("Connected to game server");
                    
                    // Send player name to server
                    socket.send(JSON.stringify({
                        type: "set_name",
                        name: playerName
                    }));
                };

                socket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                };

                socket.onerror = function(error) {
                    console.error("WebSocket error:", error);
                    setStatusMessage("Connection error. Trying to reconnect...", "red");
                    
                    // Try to reconnect after a delay
                    setTimeout(connectWebSocket, 3000);
                };

                socket.onclose = function() {
                    console.log("WebSocket connection closed");
                    setStatusMessage("Connection lost. Refresh to reconnect.", "red");
                };
            }

            function handleWebSocketMessage(message) {
                console.log("Received message:", message);
                
                switch (message.type) {
                    case "player_joined":
                        updatePlayerCount(message.players.length);
                        if (message.playerId === playerId && message.playerName) {
                            playerNameEl.textContent = message.playerName;
                        }
                        if (message.roomId) {
                            currentRoom = message.roomId;
                            roomInfoEl.textContent = `Room: ${currentRoom}`;
                        }
                        break;

                    case "name_set":
                        if (message.playerId === playerId) {
                            playerNameEl.textContent = message.playerName;
                        }
                        updatePlayerCount(message.players.length);
                        break;

                    case "game_start":
                        initGame(message.students, message.teacher, message.firstMonitor);
                        break;

                    case "chat_message":
                        addChatMessage(
                            message.sender,
                            message.text,
                            message.sender !== playerName
                        );
                        break;

                    case "student_talking":
                        if (students[message.studentId]) {
                            startTalking(message.studentId);
                        }
                        break;

                    case "student_caught":
                        if (students[message.studentId]) {
                            makeStudentMonitor(message.studentId);
                            if (message.credits !== undefined) {
                                students[message.studentId].credits = message.credits;
                                updateStudentCreditsUI(message.studentId);
                                if (message.studentId === playerId) {
                                    updatePlayerCreditsUI();
                                }
                            }
                        }
                        break;
                        
                    case "new_monitor":
                        if (students[message.studentId]) {
                            makeStudentMonitor(message.studentId);
                        }
                        break;

                    case "student_expelled":
                        if (students[message.studentId]) {
                            expelStudent(message.studentId);
                            showExpelledVerse(message.studentId);
                        }
                        break;
                        
                    case "player_left":
                        updatePlayerCount(message.players.length);
                        setStatusMessage("A player left the game", "red");
                        break;
                        
                    case "room_full":
                        setStatusMessage("Room is full. Creating a new room...", "blue");
                        break;
                }
            }

            function sendWebSocketMessage(message) {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify(message));
                } else {
                    console.error("WebSocket is not connected");
                }
            }

            function updatePlayerCount(count) {
                playerCountEl.textContent = `Players: ${count}/16`;
            }

            // --- GAME SETUP ---
            function initGame(studentData, teacherData, firstMonitorId) {
                students = studentData;
                teacher = teacherData;
                gameStarted = true;
                teacherIsMonitoring = true;

                benchesContainer.innerHTML = "";
                const corridorChildren = Array.from(corridor.children);
                corridorChildren.forEach((child) => {
                    if (child.id && child.id.startsWith("expelled"))
                        corridor.removeChild(child);
                });

                // Setup teacher
                teacherContainer.innerHTML = `
                    <div id="teacher" class="relative transition-all duration-1000 ease-in-out">
                        <div class="teacher-face" style="background-color: #333; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">MC</div>
                    </div>
                `;
                const teacherEl = document.getElementById("teacher");
                teacherEl.classList.add("teacher-nod");

                // Create benches and students
                for (let i = 0; i < 8; i++) {
                    const bench = document.createElement("div");
                    bench.className =
                        "student-bench bg-[var(--wood-light)] pixel-border flex justify-around items-center";
                    bench.style.justifySelf = "center";

                    for (let j = 0; j < 2; j++) {
                        const studentId = i * 2 + j;
                        const student = students[studentId];
                        const artist = ARTISTS[studentId];

                        const studentEl = document.createElement("div");
                        studentEl.id = `student-${studentId}`;
                        studentEl.className =
                            "student relative flex flex-col items-center cursor-pointer";
                        studentEl.innerHTML = `
                            <div class="speech-bubble">...</div>
                            <div class="student-face" style="background-color: ${artist.color}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${student.name.charAt(0)}</div>
                            <div class="text-xs text-center">${student.name.split(" ")[0]}</div>
                            <div class="text-xs text-yellow-300 mt-1.5">C: ${student.credits}</div>
                        `;

                        if (studentId === playerId) {
                            studentEl.classList.add("border-2", "border-blue-400", "rounded-md");
                        }

                        bench.appendChild(studentEl);
                    }
                    benchesContainer.appendChild(bench);
                }

                playerNameEl.textContent = students[playerId].name;
                updatePlayerCreditsUI();

                addStudentClickListeners();

                // Start the game after a brief delay
                setTimeout(() => {
                    teacherEl.classList.remove("teacher-nod");
                    gameStatus.textContent = "Class has started. Be quiet!";
                    teacherIsMonitoring = false;
                    chatInput.disabled = false;
                    sendBtn.disabled = false;

                    // Clear the initial message
                    if (chatMessages.querySelector(".text-gray-400")) {
                        chatMessages.innerHTML = "";
                    }

                    // The teacher catches the first monitor
                    setTimeout(() => {
                        gameStatus.textContent = `The teacher caught ${students[firstMonitorId].name} talking!`;
                        makeStudentMonitor(firstMonitorId);
                    }, 2000);
                }, 3000);
            }

            function addStudentClickListeners() {
                document.querySelectorAll(".student").forEach((el) => {
                    el.addEventListener("click", handleStudentClick);
                });
            }

            // --- GAME LOGIC ---
            function handleStudentClick(event) {
                if (
                    !gameStarted ||
                    students[playerId].isExpelled ||
                    !students[playerId].isStanding
                )
                    return;

                const clickedEl = event.currentTarget;
                const clickedId = parseInt(clickedEl.id.split("-")[1]);
                const clickedStudent = students[clickedId];
                
                if (clickedStudent.isTalking) {
                    setStatusMessage(`You caught ${clickedStudent.name}!`, "green");

                    sendWebSocketMessage({
                        type: "student_caught",
                        studentId: clickedId,
                    });
                } else {
                    setStatusMessage("False alarm! They were not talking.", "red");
                }
            }

            function makeStudentMonitor(studentId) {
                if (students[studentId].isExpelled) return;

                if (monitorId !== null && monitorId !== studentId) {
                    students[monitorId].isStanding = false;
                    const oldMonitorEl = document.getElementById(`student-${monitorId}`);
                    if (oldMonitorEl) oldMonitorEl.classList.remove("standing");
                }
                
                const student = students[studentId];
                student.isStanding = true;
                monitorId = studentId;
                
                const studentEl = document.getElementById(`student-${studentId}`);
                studentEl.classList.add("standing");
                
                setStatusMessage(`${student.name} is the new monitor!`, "yellow");
            }

            function expelStudent(studentId) {
                const student = students[studentId];
                if (student.isExpelled) return;
                student.isExpelled = true;
                student.isStanding = false;

                setStatusMessage(`${student.name} has been sent to the corridor!`, "red");

                const studentEl = document.getElementById(`student-${studentId}`);
                const expelledFace = studentEl.querySelector(".student-face").cloneNode(true);
                expelledFace.classList.add("mb-2", "z-20", "relative");
                expelledFace.id = `expelled-${studentId}`;
                corridor.appendChild(expelledFace);
                studentEl.style.opacity = "0.3";
                studentEl.style.pointerEvents = "none";
                
                if (studentId === playerId) {
                    gameStatus.textContent = "GAME OVER. You were expelled.";
                    chatInput.disabled = true;
                    sendBtn.disabled = true;
                }
            }

            function showExpelledVerse(studentId) {
                const artist = ARTISTS[studentId];
                if (!artist) return;

                const verseEl = document.createElement("div");
                verseEl.className = "expelled-verse";
                verseEl.textContent = `${students[studentId].name} says: "${artist.verse}"`;

                document.body.appendChild(verseEl);

                // Remove after animation completes
                setTimeout(() => {
                    document.body.removeChild(verseEl);
                }, 5000);
            }
            
            function startTalking(studentId) {
                const student = students[studentId];
                if (!student || student.isExpelled || student.isStanding) return;
                const studentEl = document.getElementById(`student-${studentId}`);
                const speechBubble = studentEl.querySelector(".speech-bubble");
                speechBubble.textContent = "...";
                student.isTalking = true;
                studentEl.classList.add("talking");
                setTimeout(() => {
                    student.isTalking = false;
                    const el = document.getElementById(`student-${studentId}`);
                    if (el) el.classList.remove("talking");
                }, 500);
            }
            
            // --- UI & CHAT ---
            function handlePlayerChat() {
                const text = chatInput.value.trim();
                if (
                    text === "" ||
                    students[playerId].isStanding ||
                    students[playerId].isExpelled
                ) {
                    if (students[playerId].isStanding)
                        setStatusMessage("You can't talk while standing!", "red");
                    return;
                }

                addChatMessage("You", text);

                sendWebSocketMessage({
                    type: "chat_message",
                    text: text,
                    studentId: playerId,
                });

                // Also show the talking animation for the player
                startTalking(playerId);

                chatInput.value = "";
            }
            
            function addChatMessage(sender, message, isOther = false) {
                const msgEl = document.createElement("p");
                msgEl.innerHTML = `<strong style="color: ${
                    isOther ? "#90cdf4" : "#f6e05e"
                };">${sender}:</strong> ${message}`;
                chatMessages.appendChild(msgEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function setStatusMessage(msg, color) {
                gameStatus.textContent = msg;
                const colorMap = {
                    red: "text-red-400",
                    green: "text-green-400",
                    yellow: "text-yellow-300",
                    blue: "text-blue-400"
                };
                gameStatus.className = `text-center text-xl h-12 ${
                    colorMap[color] || "text-yellow-300"
                }`;
            }
            
            function updatePlayerCreditsUI() {
                playerCreditsEl.textContent = students[playerId].credits;
                if (students[playerId].credits < 5) {
                    playerCreditsEl.className = "font-bold text-red-500";
                } else if (students[playerId].credits < 10) {
                    playerCreditsEl.className = "font-bold text-yellow-400";
                } else {
                    playerCreditsEl.className = "font-bold text-green-400";
                }
            }
            
            function updateStudentCreditsUI(studentId) {
                const student = students[studentId];
                const el = document.getElementById(`student-${studentId}`);
                if (el) {
                    el.querySelector(".text-yellow-300").textContent = `C: ${student.credits}`;
                }
            }
            
            // --- EVENT LISTENERS ---
            joinGameBtn.addEventListener("click", () => {
                if (playerNameInput.value.trim() === "") {
                    alert("Please enter your name");
                    return;
                }

                playerName = playerNameInput.value.trim();
                startModal.style.display = "none";
                connectWebSocket();
            });

            sendBtn.addEventListener("click", handlePlayerChat);
            chatInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter") handlePlayerChat();
            });
            
            // Initialize with player name input focused
            playerNameInput.focus();
        });
    </script>
</body>
</html>
